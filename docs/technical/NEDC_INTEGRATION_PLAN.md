# NEDC Integration Plan (Technical)

Note: The canonical, up-to-date plan now lives at `NEDC_INTEGRATION_PLAN.md` in the repository root. Keep this technical note in sync or replace with a short link if preferred.

## Decision: Full NEDC Software Integration âœ…

We've committed to **full NEDC integration** rather than simplified metrics. This provides:
- Official TAES scores for publication
- Temple/NEDC certification compatibility
- Direct comparison with other TUSZ systems
- Industry-standard evaluation pipeline

## Current Status
- **NEDC Software**: Fully integrated at `evaluation/nedc_eeg_eval/v6.0.0/`
- **TUSZ Evaluation**: Running (18% complete, ETA ~15 minutes)
- **Next Step**: Build complete pipeline from SeizureTransformer â†’ NEDC

## Complete Pipeline Architecture

```
SeizureTransformer â†’ Predictions â†’ CSV Converter â†’ NEDC Scorer â†’ Results
     (Model)         (Checkpoint)    (Pipeline)      (TAES)     (Metrics)
```

## Implementation Components

### 1. Prediction Storage (âœ… Complete)
```python
# evaluation/tusz/checkpoint.pkl
{
    "file_id": {
        "predictions": [0.1, 0.9, 0.8, ...],  # Per-sample probabilities
        "seizure_events": [(42.3, 81.7), ...], # Ground truth
        "error": None
    }
}
```

### 2. CSV Converter (ðŸ”§ Need to Build)
```python
# evaluation/nedc_scoring/convert_predictions.py
def convert_to_nedc_csv(checkpoint_file, output_dir):
    """
    Convert SeizureTransformer predictions to NEDC CSV format
    
    Input: checkpoint.pkl with predictions
      Output:
        - output/hyp/*.csv_bi (predictions)
        - output/ref/*.csv_bi (ground truth)
    """
    # Apply threshold (0.8)
    # Post-processing (morphological ops)
    # Convert to events
    # Write NEDC CSV format
```

### 3. List Files (âœ… Generated by converter)
The converter writes absolute paths to `output/lists/ref.list` and `output/lists/hyp.list`.

### 4. NEDC Runner (ðŸ”§ Need to Build)
```python
# evaluation/nedc_scoring/run_nedc.py
def run_full_nedc_evaluation():
    """
    Execute complete NEDC pipeline
    """
    # 1. Convert predictions to CSV
    # 2. Create list files
    # 3. Set NEDC environment
    # 4. Run NEDC scorer
    # 5. Parse results
    return {
        "taes_sensitivity": 0.823,
        "taes_fa_per_24h": 7.2,
        "taes_f1": 0.765
    }
```

### 5. Post-Processing Pipeline (ðŸ”§ Need to Build)
```python
# evaluation/nedc_scoring/post_processing.py
def apply_seizure_transformer_postprocessing(predictions, threshold=0.8):
    """
    Apply paper's post-processing:
    1. Threshold at 0.8
    2. Morphological opening (kernel=5)
    3. Morphological closing (kernel=5)
    4. Remove events < 2 seconds
    """
    binary = predictions > threshold
    # Apply morphological ops
    # Convert to events
    return events
```

## File Structure (Current)

```
evaluation/
â”œâ”€â”€ tusz/
â”‚   â”œâ”€â”€ run_tusz_eval.py         # âœ… Running now
â”‚   â”œâ”€â”€ checkpoint.pkl           # âœ… Saves predictions
â”‚   â””â”€â”€ results.json             # âœ… AUROC metrics
â”œâ”€â”€ nedc_eeg_eval/
â”‚   â””â”€â”€ v6.0.0/                  # âœ… Full NEDC software
â”œâ”€â”€ nedc_scoring/
â”‚   â”œâ”€â”€ convert_predictions.py   # ðŸ”§ TODO: Build converter
â”‚   â”œâ”€â”€ create_lists.py          # ðŸ”§ TODO: List generator
â”‚   â”œâ”€â”€ post_processing.py       # ðŸ”§ TODO: Post-processor
â”‚   â””â”€â”€ run_nedc.py             # ðŸ”§ TODO: Main runner
```

## Implementation Timeline

### Phase 1: Get AUROC (Today) âœ…
1. Complete TUSZ evaluation (~10 min remaining)
2. Verify AUROC â‰ˆ 0.876

### Phase 2: Build Pipeline (Next) ðŸ”§
1. Create CSV converter
2. Implement post-processing
3. Generate list files
4. Test NEDC execution

### Phase 3: Full Integration ðŸŽ¯
1. Run complete pipeline
2. Get official TAES scores
3. Compare with paper's metrics

## NEDC CSV Format Reference

**Hypothesis (Model Output):**
```csv
# version = csv_v1.0.0
# bname = aaaaaaaq_s006_t000
# duration = 1800.0000 secs
channel,start_time,stop_time,label,confidence
TERM,45.0000,82.0000,seiz,1.0000
TERM,134.0000,161.0000,seiz,1.0000
```

**Reference (Ground Truth):**
```csv
# version = csv_v1.0.0
# bname = aaaaaaaq_s006_t000
# duration = 1800.0000 secs
channel,start_time,stop_time,label,confidence
TERM,42.2786,81.7760,seiz,1.0000
TERM,133.8040,162.1105,seiz,1.0000
```

  ## Environment Setup for NEDC (SSOT)

  ```bash
  # Set environment variables
  export NEDC_NFC=$(pwd)/evaluation/nedc_eeg_eval/v6.0.0
  export PATH=$NEDC_NFC/bin:$PATH
  export PYTHONPATH=$NEDC_NFC/lib:$PYTHONPATH

  # Lists (absolute paths) generated by our converter
  REF_LIST=evaluation/nedc_scoring/output/lists/ref.list
  HYP_LIST=evaluation/nedc_scoring/output/lists/hyp.list

  # Run NEDC scorer with explicit output directory
  $NEDC_NFC/bin/nedc_eeg_eval "$REF_LIST" "$HYP_LIST" \
    -o evaluation/nedc_scoring/output/results
  ```

## Expected Output from NEDC

```
TAES Metrics:
  Sensitivity: 0.823 (82.3%)
  False Alarms/24h: 7.2
  F1 Score: 0.765
  
OVLP Metrics:
  Overlap ratio: 0.791
  
EPOCH Metrics:
  Epoch accuracy: 0.884
```

## Success Criteria

1. **AUROC**: Should be ~0.876 (paper's claim)
2. **TAES Sensitivity**: Should be >80%
3. **FA/24h**: Should be <10 for clinical use
4. **Pipeline**: Fully automated, reproducible

## Next Actions

1. âœ… Let TUSZ evaluation complete
2. ðŸ”§ Build CSV converter
3. ðŸ”§ Implement post-processing
4. ðŸ”§ Create NEDC runner
5. ðŸŽ¯ Get official TAES scores

## Notes

- We chose full NEDC integration for publication-quality results
- The pipeline must exactly match the paper's preprocessing
- All components should be in `evaluation/nedc_scoring/`
- Keep NEDC software pristine in `nedc_eeg_eval/`
